name: "Spec"
on:
  push:
    branches:
      - main
    tags:
      - v*
  pull_request:
  workflow_dispatch:

jobs:
  validate-openapi:
    name: "ðŸ”Ž Validate OpenAPI specifications"
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“¥ Source checkout"
        uses: actions/checkout@v2
      - name: "âž• Setup Node"
        uses: actions/setup-node@v2
        with:
          node-version: '14'
      - name: "âš™ï¸ npm"
        working-directory: "./scripts"
        run: |
          npm install
      - name: "ðŸ”Ž Run validator"
        working-directory: "./scripts"
        run: |
          node validator.js -s "../data/api/client-server"

  check-examples:
    name: "ðŸ”Ž Check Event schema examples"
    runs-on: ubuntu-latest
    steps:
      - name: "ðŸ“¥ Source checkout"
        uses: actions/checkout@v2
      - name: "ðŸ”Ž Run validator"
        container: uhoreg/matrix-doc-build
        run: |
          /env/bin/python scripts/check-event-schema-examples.py
        
  build-openapi:
    name: "ðŸ Build OpenAPI definitions"
    runs-on: ubuntu-latest
    container: "python:3.9"
    steps:
      - name: "ðŸ“¥ Source checkout"
        uses: actions/checkout@v2
      - name: "ðŸ“¦ Asset creation"
        run: |
          python3 -m venv env && . env/bin/activate
          pip install -r scripts/requirements.txt
          scripts/generate-matrix-org-assets
      - name: "ðŸ“¤ Artifact upload"
        uses: actions/upload-artifact@v2
        with:
          name: openapi-artifact
          path: assets.tar.gz

  build-spec:
    name: "ðŸ“– Build the spec"
    runs-on: ubuntu-latest
    steps:
      - name: "âž• Setup Node"
        uses: actions/setup-node@v2
        with:
          node-version: '14'
      - name: "âž• Setup Hugo"
        uses: peaceiris/actions-hugo@c03b5dbed22245418539b65eb9a3b1d5fdd9a0a6
        with:
          hugo-version: '0.85.0'
          extended: true
      - name: "ðŸ“¥ Source checkout"
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: "âš™ï¸ npm"
        run: |
          npm i
          npm run get-proposals

      # For PRs, set the baseURL to `/`.
      # For releases, set the baseURL to `/$tag` (eg: `/v1.2`).
      # Otherwise, set it to `/unstable`.
      - name: "âš™ï¸ Calculate baseURL"
        id: set-baseurl
        # Double brackets on the elif to avoid auto-escaping refs/tags/* because we need
        # the asterisk matching behaviour, not the literal string.
        run: |
          if [ "${GITHUB_EVENT_NAME}" == "pull_request" ]; then
              echo ::set-output name=baseURL::/
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
              echo ::set-output name=baseURL::"/${GITHUB_REF/refs\/tags\//}"
          else
              echo ::set-output name=baseURL::/unstable
          fi

      - name: "âš™ï¸ hugo"
        run: hugo --baseURL "${{ steps.set-baseurl.outputs.baseURL }}" -d "spec"
      - name: "ðŸ“¦ Tarball creation"
        run: tar -czf spec.tar.gz spec
      - name: "ðŸ“¤ Artifact upload"
        uses: actions/upload-artifact@v2
        with:
          name: spec-artifact
          path: spec.tar.gz

  build-historical-spec:
    name: "ðŸ“– Build the historical backup spec"
    runs-on: ubuntu-latest
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    steps:
      - name: "âž• Setup Node"
        uses: actions/setup-node@v2
        with:
          node-version: '14'
      - name: "âž• Setup Hugo"
        uses: peaceiris/actions-hugo@c03b5dbed22245418539b65eb9a3b1d5fdd9a0a6
        with:
          hugo-version: '0.85.0'
          extended: true
      - name: "ðŸ“¥ Source checkout"
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: "âš™ï¸ npm"
        run: |
          npm i
          npm run get-proposals
      - name: "âš™ï¸ hugo"
        # Create a baseURL like `/v1.2` out of the `v1.2` tag
        run: |
          echo -e '[params.version]\nstatus="historical"' > historical.toml
          hugo --config config.toml,historical.toml --baseURL "/${GITHUB_REF/refs\/tags\//}" -d "spec"
      - name: "ðŸ“¦ Tarball creation"
        run: tar -czf spec-historical.tar.gz spec
      - name: "ðŸ“¤ Artifact upload"
        uses: actions/upload-artifact@v2
        with:
          name: spec-historical-artifact
          path: spec-historical.tar.gz
